# AI_Orchastrator

## Updates
- 2026-02-08: **Admin Users page frontend caching**: Users tab now uses the same React Query + tenant-aware caching as Contacts and Forms. `app/admin/(main)/users/page.tsx` uses `useTenantQuery` for the users list (queryKey `["users"]`, staleTime 2 min), `useTenantQueryKey().getTenantQueryKey(["users"])` for invalidation, and `useMutation` with invalidation for create/update/delete. Removed manual `useState`/`useEffect`/`loadUsers` in favor of cached data and refetch.
- 2026-02-08: **Card form JSON = manual shape (single format everywhere)**: When a user creates a card form via JSON (Import, Build with AI, or paste with schema+edges), the resulting stored/exported JSON is the same format as manual builder. **Canonical format** (single source of truth): `frontend/lib/forms/flowchart-serialization.ts` (comment + implementation): edge id `e-{source}-{target}`, positions start (400,0), first content y=100, step 120. **AI**: `backend-api/.../card-form-ai-prompt.config.ts` — intro instructions now spell out this same format; full example uses y: 100, 220, 340, 460 and edges `e-start-welcome`, etc. **Frontend**: Import "Load example" uses `schemaToFlowchart(schema)` so it emits the same shape. Paste/import with `flowchartGraph` uses payload as-is after `validateFlowchartGraph`.
- 2026-02-07: **Card form flowchart format (no drift)**: AI and import no longer rely on external node shapes. **Build with AI**: AI outputs `schema` (FormField[]) and `flowchartEdges` ({ source, target }[]), not `flowchartGraph`; the app builds the graph with `buildFlowchartFromSchemaAndEdges()` in `frontend/lib/forms/flowchart-serialization.ts`, so the canonical node shape is always produced by our code. **Paste/import**: Payload may still have `flowchartGraph`; we normalize with `normalizeFlowchartGraph`. `CardFormTemplateJson` accepts either `schema` (+ optional `flowchartEdges`) or `flowchartGraph`. AI prompt: `backend-api/.../forms/config/card-form-ai-prompt.config.ts` (schema + flowchartEdges example and instructions). Apply logic in new/edit pages: prefer schema+edges → build graph; else schema only → schemaToFlowchart; else flowchartGraph → normalize.
- 2026-02-07: **AI Card Form Builder (implemented)**: Build with AI uses hardcoded prompt (Option B). Backend: `POST /forms/ai-card-form-chat` (JwtAuthGuard, AdminGuard), `CardFormAIService` in `backend-api/.../forms/services/card-form-ai.service.ts` with hardcoded system prompt; DTO `CardFormAiChatDto` (message, currentCardFormPayload?, conversationHistory?). Frontend: "Build with AI" button in Card Form Builder section header; `CardFormAIBuilderModal` (chat, current form sent as context, parse JSON from reply, "Apply to form"); `api.forms.cardFormAiChat()`; `extractCardFormJsonFromText()` in `frontend/lib/forms/extract-card-form-json.ts`. Plans: `.helper/plan/ai-card-form-builder.md`, `.helper/plan/ai-card-form-builder-prompt-strategy.md`.
- 2026-02-07: **AI Card Form Builder (plans)**: Feature plan and prompt strategy added. Feature: button at top of Card Form Builder opens modal with AI chat; AI asks clarifying questions and outputs CardFormTemplateJson (images via links only); result applied via existing `onImportFullCardForm`. **Current card form data** is sent to the AI as context (via `getFullCardFormPayload()` / `currentCardFormPayload`) so the AI can create from scratch or refine/extend the existing form. Plans: `.helper/plan/ai-card-form-builder.md` (flow, UI, backend endpoint, validation, current-form context), `.helper/plan/ai-card-form-builder-prompt-strategy.md` (Option A: prompt data model + seed vs Option B: hardcoded server prompt; recommendation: start with B for MVP).
- 2026-02-07: **Image options for multiple choice**: Select, radio, and checkbox fields can show options as **text** or **images** (per-field; no mixing). Data: `FormFieldOption` = `string | { value, imageUrl, altText? }`, `FormField.optionDisplay?: 'text' | 'image'`. Helpers: `frontend/lib/forms/option-utils.ts` (`getOptionValue`, `getOptionLabel`, `getOptionAlt`, `getOptionImageUrl`, `isImageOption`, `getOptionValues`). Admin: Simple form field editor and Card settings panel have “Options display: Text | Images” and, in image mode, rows with Value / Image URL / Alt text. Public: `FieldRenderer` renders image tiles for radio/checkbox/select when `optionDisplay === 'image'`; stored and submitted value remains option value (string/string[]). Validation, logic builder, profile estimation (percentage + multi-dimension), and forms list use option helpers. Plan: `.helper/plan/image-options-for-multiple-choice.md`.
- 2026-02-07: Added admin **Monitor** tab for backend debugging: rate limits (per IP/key), DB table counts, system status. Backend: `GET /general/monitor-stats` (admin/super_admin), `GeneralService.getMonitorStats()` + `CacheService.getKeysByPattern()` for Redis rate-limit keys; frontend: `app/admin/(main)/monitor/page.tsx` (tabs: Overview, Rate limits, Database), sidebar nav “Monitor” (Activity icon), `api.adminAuth.getMonitorStats()` and types in `admin-auth.ts` / `admin-auth.config.ts`.
- 2026-02-07: Implemented Phase 3 Card Form UI Builder: theme presets (form-styling-presets.ts: Minimal, Dark, Light, Brand), contrast check (contrast-utils.ts + WCAG AA warning in Appearance), base font size input (14–24, recommended 16–18) and --form-base-font-size on public form.
- 2026-02-07: Implemented Phase 1 Card Form UI Builder: FormStyling type, FormAppearanceSection, form-styling-utils + CSS vars, CardFormView theme vars. Plan: .helper/plan/card-form-ui-builder-plan.md.
- 2026-02-07: Added plan for Card Form UI Builder (theme/styling layer): `.helper/plan/card-form-ui-builder-plan.md`. Proposal for admin “Appearance” section (fonts, colors, card/button options) and public application via CSS variables; FormTemplate.styling as single source of truth; phased implementation (MVP → more options + preview → presets + a11y).
- 2026-02-07: Form field types: removed leftover "email" and "phone" handling. Admin submission detail page `app/admin/(main)/forms/submissions/[id]/page.tsx` no longer switches on email/phone (they were removed from FormFieldType); backend DTO `backend-api/.../dto/create-form-template.dto.ts` updated to drop email/phone and include statement to match frontend `FormFieldType`.
- 2026-02-07: Card settings panel (node edit dialog) refactored to use parent form: CardSettingsPanel no longer uses its own useForm(); it uses useFormContext<FormTemplateFormValues>() and reads/writes node data at cardSettings.flowchartGraph.nodes[nodeIndex].data. Single form ownership—avoids nested form sync issues. CardFormBuilder passes nodeIndex; handleNodeUpdate removed.
- 2026-02-07: Implemented system-wide frontend refactor (Phase 1 pilot): parent-owned RHF for Profile Estimation; single form in route (new/edit pages), children use `useFormContext` only; `useFieldArray` moved to `ProfileEstimationSetup` (setup-wizard) and passed to CategoryConfig, PercentageConfig, MultiDimensionConfig, RecommendationConfig as props; stable IDs via `lib/utils/stable-id.ts` (`generateStableId`) replacing all `Date.now()` for categories, dimensions, recommendations, schema fields; `reset()` on edit page remains only in `loadTemplate()` after API fetch (true external load). Profile Estimation configs: `frontend/components/admin/forms/profile-estimation/`. Form template pages: `frontend/app/admin/(main)/forms/new/page.tsx`, `[id]/edit/page.tsx`.
- 2026-02-06: Avoid reset on same-value updates in `ProfileEstimationSetup` by comparing serialized signatures, preventing input focus loss while typing in category names.
- 2026-02-06: Added design doc for local-first Profile Estimation editing to prevent focus loss while typing.
- 2026-02-06: Added system-wide frontend refactor design doc.
